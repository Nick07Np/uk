export default async function handler(req, res) {
  const page = Number(req.query.page || 1);
  const perPage = 50;

  const query = `
    query ($page: Int, $perPage: Int) {
      Page(page: $page, perPage: $perPage) {
        pageInfo { hasNextPage }
        media(type: ANIME, sort: POPULARITY_DESC) {
          id
          title { romaji english }
          coverImage { large }
          episodes
          averageScore
        }
      }
    }
  `;

  try {
    const response = await fetch("https://graphql.anilist.co", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query, variables: { page, perPage } }),
    });
    const data = await response.json();

    res.setHeader("Cache-Control", "s-maxage=3600, stale-while-revalidate");
    res.status(200).json(data.data.Page);
  } catch (err) {
    res.status(500).json({ error: "Failed to fetch AniList data" });
  }
}
